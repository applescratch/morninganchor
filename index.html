<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Anchor Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcf0; /* Soft Off-White Background */
            padding: 10px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; 
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(44, 62, 80, 0.1); /* Deep Shadow */
            margin-bottom: 16px;
            padding: 16px;
        }
        .discipline-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .discipline-item:last-child {
            border-bottom: none;
        }
        /* Custom Colors */
        .color-teal { background-color: #008080; } /* Moss Teal Green */
        .color-pink { background-color: #ffb6c1; } /* Light Pink */
        .color-gold { color: #ccac00; } /* Gold Text */
        
        .status-message {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffb6c1; /* Soft Pink for status */
            color: #2c3e50;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(252, 252, 240, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        .timer-display {
            font-size: 2.8rem;
            font-weight: 800;
            color: #008080; /* Moss Teal */
        }
        .ai-output-box {
            background-color: #fcfcf0; /* Cream background */
            border: 1px solid #ccac00; /* Gold border */
            border-left: 5px solid #ccac00;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .history-entry {
            border-bottom: 1px dashed #ccc;
            padding-bottom: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .mic-btn {
            background-color: transparent;
            border: none;
            color: #ffb6c1; /* Soft Pink */
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s;
        }
        .mic-btn.listening {
            color: red;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Custom Class for Header Centering */
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            text-align: center;
        }
        .streak-box {
            display: flex;
            justify-content: center; /* Center the streak elements */
            align-items: center;
            width: 100%;
            padding-top: 8px;
        }
        /* Emergency Message Styling */
        #emergency-save-message {
            background-color: #fcebeb; /* Light red/pink background */
            color: #cc0000;
            border: 2px solid #cc0000;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            text-align: center;
            /* Added margin and z-index to ensure visibility */
            margin-bottom: 15px; 
            z-index: 900; 
        }
        .emergency-btn {
            background-color: #cc0000;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- GLOBAL CONFIGURATION & STATE ---
        let db, auth, userId = null;
        const today = new Date();
        const todayKey = today.toISOString().split('T')[0]; // YYYY-MM-DD
        const formattedDate = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-anchor-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Discipline IDs (mapped to database fields and UI)
        const disciplines = {
            'discipline-pray': 'Pray',
            'discipline-read': 'Read',
            'discipline-learn': 'Learn',
            'discipline-wellness': 'Wellness',
            'discipline-dream': 'Dream',
            'discipline-journal': 'Journal'
        };
        let timerInterval = null;
        let timerSeconds = 60;
        let recognition = null; // For Speech-to-Text
        
        // --- API KEY HANDLING (CRITICAL FIX) ---
        let savedApiKey = localStorage.getItem('GEMINI_API_KEY') || "";

        // --- AUTHENTICATION STATE TRACKING ---
        let isAuthenticated = false;


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // CRITICAL FIX: Set persistence to session to prevent immediate token drop
                // This correctly imports persistence from auth.js (Fixes "unknown export" error)
                await setPersistence(auth, browserSessionPersistence);

                // Set up listener to manage session state globally
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthenticated = true;
                        document.getElementById('user-id').textContent = `Session: Connected (User ${userId.substring(0, 8)}...)`;
                        document.getElementById('user-id').style.color = '#ffb6c1'; // Soft Pink for connected state
                        loadDailyData();
                    } else {
                        userId = null;
                        isAuthenticated = false;
                        document.getElementById('user-id').textContent = 'Session: Disconnected. Sign In to save.';
                        document.getElementById('user-id').style.color = '#cc0000'; // Red for disconnected state
                        hideLoading();
                    }
                });

                // Force Anonymous Sign In on Load (No pop-up needed)
                await signInAnonymously(auth);

                // --- FAIL-SAFE TIMER (CRITICAL FIX) ---
                setTimeout(() => {
                    if (document.getElementById('loading-screen').style.opacity !== '0') {
                        displayMessage('Connection timeout. Check your network/hosting URL.', 'error');
                        hideLoading();
                    }
                }, 5000); // Guarantees loading screen closes after 5s

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage('App initialization failed. Please try again.', 'error');
                hideLoading();
            }
        }
        
        async function reconnectSession() {
            if (isAuthenticated) {
                displayMessage('Already signed in!', 'success');
                return;
            }
            displayMessage('Attempting Reconnect...', 'success');
            
            try {
                // Force Anonymous Sign In
                await signInAnonymously(auth);
                // onAuthStateChanged listener handles the success
            } catch (error) {
                console.error("Anonymous Sign In Failed:", error);
                displayMessage('Failed to reconnect. Please refresh the page.', 'error');
            }
        }


        // --- API KEY CONFIGURATION ---
        function saveApiKey() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            if (inputKey.length > 5 && inputKey.startsWith('AIza')) { // Basic validation
                localStorage.setItem('GEMINI_API_KEY', inputKey);
                savedApiKey = inputKey;
                document.getElementById('api-status').textContent = 'Key Saved! AI features enabled.';
                document.getElementById('api-status').classList.remove('text-red-500');
                document.getElementById('api-status').classList.add('text-[#008080]');
                displayMessage('API Key Saved Successfully! AI is now active.');
            } else {
                displayMessage('Please enter a valid Gemini API Key (starts with AIza).', 'error');
            }
        }

        function checkApiKeyStatus() {
            const statusElement = document.getElementById('api-status');
            if (savedApiKey) {
                statusElement.textContent = 'Key Active. AI features enabled.';
                statusElement.classList.remove('text-red-500');
                statusElement.classList.add('text-[#008080]');
                document.getElementById('api-key-input').value = savedApiKey.substring(0, 5) + '...';
            } else {
                statusElement.textContent = 'Key Required. AI features disabled.';
                statusElement.classList.remove('text-[#008080]');
                statusElement.classList.add('text-red-500');
            }
        }
        
        function displaySavedKey() {
            if (savedApiKey) {
                const partialKey = savedApiKey.substring(0, 8);
                document.getElementById('api-status').textContent = `Loaded Key: ${partialKey}...`;
            } else {
                document.getElementById('api-status').textContent = "No key found in browser storage.";
            }
        }


        // --- DATABASE FUNCTIONS ---
        const getDailyDocRef = (uid) => doc(db, `artifacts/${app_id}/users/${uid}/morning_checkins`, todayKey);
        const getCollectionRef = (uid) => collection(db, `artifacts/${app_id}/users/${uid}/morning_checkins`);

        async function loadDailyData() {
            const docRef = getDailyDocRef(userId);
            
            // Set up real-time listener for checklist and streaks
            onSnapshot(docRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                
                // 1. Update Checkboxes
                Object.keys(disciplines).forEach(id => {
                    const field = disciplines[id];
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = !!data[field];
                        if (field === 'Read' && data[field]) {
                             document.getElementById('timer-btn').disabled = true;
                             document.getElementById('timer-btn').textContent = "READ DONE!";
                             document.getElementById('timer-display').textContent = "00:00";
                        } else if (field === 'Read' && !data[field]) {
                             document.getElementById('timer-btn').disabled = false;
                             document.getElementById('timer-btn').textContent = "START 1-MINUTE READ";
                             if (timerInterval === null) {
                                document.getElementById('timer-display').textContent = "01:00";
                             }
                        }
                    }
                });

                // 2. Update Long Text Areas
                document.getElementById('dream-log').value = data.DreamLog || '';
                document.getElementById('journal-log').value = data.JournalLog || '';

                // 3. Update Streak Display 
                document.getElementById('streak-count').textContent = data.streak || 0; 

                hideLoading();
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                displayMessage('Error loading data. Check connection and sign in.', 'error');
                hideLoading();
            });
        }

        async function toggleDiscipline(event) {
            // PROACTIVE AUTH CHECK (Critical for saving)
            if (!isAuthenticated) {
                document.getElementById('emergency-save-message').style.display = 'block';
                displayMessage('Session lost. Click "RECONNECT / SIGN IN" above.', 'error');
                return;
            }
            
            const field = event.target.dataset.field;
            const isChecked = event.target.checked;
            
            // FIX: Use setDoc with merge: true to CREATE the document if it doesn't exist
            try {
                await setDoc(getDailyDocRef(userId), { [field]: isChecked }, { merge: true });
                displayMessage(`${field} status saved!`);
                document.getElementById('emergency-save-message').style.display = 'none'; // Clear emergency message on success
            } catch (e) {
                // FINAL FIX: This is the failure point. Prompt user to copy/refresh.
                document.getElementById('emergency-save-message').style.display = 'block';
                displayMessage('CRITICAL SAVE FAILURE: Checkbox save failed. Click RECONNECT/SIGN IN.', 'error');
            }
        }

        async function saveLongText(fieldId, dataField, checkboxId) {
            // PROACTIVE AUTH CHECK (The Fix)
            if (!isAuthenticated) {
                 displayMessage('CRITICAL SAVE FAILURE: Session lost. Copy text, then click RECONNECT.', 'error');
                 document.getElementById('emergency-save-message').style.display = 'block';
                 return; 
            }
            
            const text = document.getElementById(fieldId).value;
            const docRef = getDailyDocRef(userId);
            
            const updates = {
                [dataField]: text,
                lastUpdated: new Date().toISOString()
            };

            // Auto-check the discipline box if content is saved
            if (checkboxId) {
                const checkboxField = disciplines[checkboxId];
                updates[checkboxField] = true;
                // FIX: Checkmark logic also uses setDoc now for safety
                try {
                    await setDoc(getDailyDocRef(userId), { [checkboxField]: true }, { merge: true });
                } catch (e) {
                    console.warn('Failed to auto-check box, proceeding with text save.');
                }
            }

            // Save the journal content (always uses setDoc for safety)
            try {
                await setDoc(docRef, updates, { merge: true });
                displayMessage('Log Saved!');
                document.getElementById('emergency-save-message').style.display = 'none'; // Clear emergency message on success
            } catch (e) {
                console.error("Long text save failed:", e);
                // FINAL FIX: Provide explicit instructions to user on how to recover data before refreshing
                document.getElementById('emergency-save-message').style.display = 'block';
                displayMessage('CRITICAL SAVE FAILURE: Session expired. COPY your text NOW, then click RECONNECT.', 'error');
            }
        }
        
        async function loadJournalHistory() {
            if (!isAuthenticated) {
                document.getElementById('history-output').innerHTML = '<p class="text-red-500">History failed to load. Please sign in first.</p>';
                return;
            }
            
            document.getElementById('history-output').innerHTML = '<p class="text-teal-600">Loading history...</p>';
            const q = query(getCollectionRef(userId));
            
            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    document.getElementById('history-output').innerHTML = '<p class="text-gray-500">No past entries found.</p>';
                    return;
                }
                
                let historyHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = doc.id;
                    
                    const reflection = data.JournalLog ? `**Reflection:** ${data.JournalLog.substring(0, 150)}...` : '';
                    const dream = data.DreamLog ? `**Dream/Vision:** ${data.DreamLog.substring(0, 150)}...` : '';
                    
                    if (reflection || dream) {
                        historyHTML += `
                            <div class="history-entry">
                                <p class="font-bold text-lg text-teal-700">${date}</p>
                                ${reflection ? `<p class="mt-1 text-sm">${reflection}</p>` : ''}
                                ${dream ? `<p class="mt-1 text-sm">${dream}</p>` : ''}
                            </div>
                        `;
                    }
                });
                
                document.getElementById('history-output').innerHTML = historyHTML;
                document.getElementById('copy-history-btn').style.display = 'block';
            } catch (e) {
                console.error("History load error:", e);
                 document.getElementById('history-output').innerHTML = `<p class="text-red-500">Error: Could not load history. Please ensure you are signed in.</p>`;
            }
        }

        async function copyAllHistoryText() {
            const q = query(getCollectionRef(userId));
            const querySnapshot = await getDocs(q);
            
            let fullText = '--- FAITH FOUNDATIONS FULL JOURNAL HISTORY ---\n\n';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const date = doc.id;
                
                fullText += `\n--- ENTRY: ${date} ---\n`;
                if (data.JournalLog) fullText += `REFLECTION JOURNAL:\n${data.JournalLog}\n\n`;
                if (data.DreamLog) fullText += `DREAM/VISION LOG:\n${data.DreamLog}\n\n`;
            });

            navigator.clipboard.writeText(fullText).then(() => {
                displayMessage('Full History Copied to Clipboard!');
            }).catch(err => {
                console.error('Could not copy history: ', err);
                displayMessage('Error copying history.', 'error');
            });
        }

        // --- UI AND UTILITY FUNCTIONS ---
        function displayMessage(message, type = 'success') {
            const msgElement = document.getElementById('status-message');
            msgElement.textContent = message;
            msgElement.className = `status-message ${type === 'success' ? 'bg-[#ffb6c1]' : 'bg-red-600'} text-[#2c3e50]`;
            clearTimeout(msgElement.timeout);
            msgElement.timeout = setTimeout(() => {
                msgElement.textContent = '';
                msgElement.className = 'status-message hidden';
            }, 3000);
        }

        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            }
        }

        // --- TIMER FUNCTIONS ---
        function startTimer() {
            if (timerInterval) return;
            if (!isAuthenticated) {
                displayMessage('Sign in required to start timer and save progress.', 'error');
                return;
            }

            const timerDisplay = document.getElementById('timer-display');
            const timerButton = document.getElementById('timer-btn');
            timerSeconds = 60;
            timerDisplay.textContent = "01:00";
            timerDisplay.classList.remove('text-red-600', 'animate-pulse');

            timerButton.disabled = true;
            timerButton.textContent = 'RUNNING...';

            timerInterval = setInterval(async () => {
                timerSeconds--;

                if (timerSeconds < 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerDisplay.textContent = "TIME!";
                    timerDisplay.classList.add('text-red-600', 'animate-pulse');

                    const readCheckbox = document.getElementById('discipline-read');
                    readCheckbox.checked = true;
                    
                    // Save to Firestore and update UI via snapshot listener
                    await setDoc(getDailyDocRef(userId), { [disciplines['discipline-read']]: true }, { merge: true });
                    
                    displayMessage('Anchor Minute Complete! Read box checked.');

                    if (navigator.vibrate) {
                        navigator.vibrate(1000);
                    }

                    setTimeout(() => {
                        timerButton.textContent = "READ DONE!";
                    }, 2000);

                    return;
                }
                
                const minutes = Math.floor(timerSeconds / 60);
                const seconds = timerSeconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // --- SPEECH-TO-TEXT FUNCTIONS ---
        function toggleSpeech(targetId, micButton) {
            // Check for secure context and API support
            if (window.location.protocol !== 'https:') {
                displayMessage('Speech-to-Text requires a secure (https://) link to work.', 'error');
                return;
            }
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                displayMessage('Speech recognition not supported in this browser.', 'error');
                return;
            }

            if (recognition && recognition.state === 'listening') {
                recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US'; 

            recognition.onstart = () => {
                micButton.classList.add('listening');
                displayMessage('Listening... speak now.');
            };

            recognition.onresult = (event) => {
                const finalTranscript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                const element = document.getElementById(targetId);
                // For textarea, append text. For input, replace text.
                if (targetId === 'ai-topic') {
                    element.value = finalTranscript;
                } else {
                    element.value += (element.value ? ' ' : '') + finalTranscript;
                }

                micButton.classList.remove('listening');
                displayMessage('Transcription complete.');
            };

            recognition.onerror = (event) => {
                micButton.classList.remove('listening');
                displayMessage(`Speech error: ${event.error}. Ensure mic access is allowed.`, 'error');
                console.error('Speech Recognition Error:', event.error);
            };

            recognition.onend = () => {
                micButton.classList.remove('listening');
            };

            recognition.start();
        }


        // --- GEMINI API FUNCTIONS ---
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;

        async function fetchGemini(prompt, systemInstruction = null) {
            if (!savedApiKey) {
                const errorMessage = "AI Key Missing. Please set your Gemini API Key in the configuration card above.";
                document.getElementById('ai-insight-box').textContent = errorMessage;
                displayMessage(errorMessage, 'error');
                return null;
            }
            
            const fullUrl = `${GEMINI_API_URL}${savedApiKey}`;
            const aiInsightBox = document.getElementById('ai-insight-box');
            
            aiInsightBox.textContent = "Generating insight... please wait.";
            document.getElementById('copy-ai-btn').style.display = 'none';


            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined,
                // The config block is intentionally omitted for compatibility
            };

            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "AI failed to generate content.";
                    } else if (response.status === 400 || response.status === 403) {
                         // --- GRACEFUL ERROR PARSING START ---
                         let userError = `API Key rejected (Status: ${response.status}).`;
                         try {
                             const errorBody = await response.json();
                             userError = errorBody.error?.message || userError;
                         } catch (e) {
                             // If it's not JSON (like a simple HTML server error), handle gracefully
                             console.warn("Non-JSON API Error Response (Likely Key Failure):", await response.text());
                         }
                         
                         displayMessage(`Error: ${userError}`, 'error');
                         return `Key Error: The API key is invalid or your usage limits may have been exceeded. Please re-enter a new key.`;
                    }
                     else {
                        const errorBody = await response.text();
                        console.error(`API Error: ${response.status} - ${errorBody}`);
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        return "Error: AI service is currently unavailable after multiple retries. Check API Key validity.";
                    }
                }
            }
        }

        function updateAIOutput(text) {
            document.getElementById('ai-insight-box').textContent = text;
            document.getElementById('copy-ai-btn').style.display = 'block';
        }

        // --- AI ACTION FUNCTIONS ---

        async function handleGeneratePrayer() {
            const prayerStyle = document.getElementById('prayer-style-selector').value;
            const topic = document.getElementById('ai-topic').value.trim().replace(/['"]+/g, '') || 'my new life in Christ';

            let prompt;
            let systemInstruction;

            if (prayerStyle === 'prophetic') {
                prompt = `Start the prayer with a full paragraph dedicated to praising God for His character and thanking Him for His grace, love, and provision. Use declarative and faith-filled language. Then, generate the prayer body focusing on the topic: "${topic}". The prayer must include strong, declarative phrases like 'I decree,' 'I declare,' 'I bind,' and 'I loose.' The prayer must be grounded in Scripture and must weave in 1-3 relevant Bible verses cited using declarative phrases like 'as it says in Philippians 4:6' directly into the text. The prayer should be focused on grace and end with the declaration: 'in Jesus' mighty name, Amen.'`;
                systemInstruction = "You are a Christian spiritual warfare expert. Your output must be a bold, faith-filled declaration suitable for reading aloud and centered on God's grace.";
            } else { // Breakthrough/Clarice Fluitt style
                prompt = `Start the prayer with a full paragraph dedicated to praising God for His character and thanking Him for His grace, love, and provision. Use declarative and faith-filled language. Then, generate the prayer body focusing on the topic: "${topic}". The prayer should be bold, filled with hope, encourage stepping out in faith. The prayer must be grounded in Scripture and must weave in 1-3 relevant Bible verses cited using declarative phrases like 'as it says in Philippians 4:6' directly into the text. End with the declaration: 'in Jesus' mighty name, Amen.'`;
                systemInstruction = "You are an anointed, bold, and encouraging Christian intercessor focused on grace and breakthrough. Your output must be a powerful, heartfelt prayer.";
            }

            const prayerText = await fetchGemini(prompt, systemInstruction);
            if (prayerText) updateAIOutput(prayerText);
        }

        async function analyzeJournal() {
            const journalText = document.getElementById('journal-log').value.trim();
            const dreamText = document.getElementById('dream-log').value.trim();

            if (!journalText && !dreamText) {
                updateAIOutput("Please write some content in your Journal or Dream Log before analyzing.");
                return;
            }

            document.getElementById('copy-ai-btn').style.display = 'none';

            const combinedText = `Morning Reflection: "${journalText}" \n\n Dream/Vision: "${dreamText}"`;

            const prompt = `Analyze the following combined journal entries and dreams. Identify the underlying struggles (e.g., financial worry, self-doubt, decision fatigue, loneliness) and any revealed desires. Based on this analysis, generate a list of 3-5 specific, actionable PRAYER POINTS framed as intercession. Do not offer direct advice; only structure the prayer points. Each prayer point MUST be grounded in Scripture and cite one relevant Bible verse in parentheses (e.g., Romans 8:28).`;
            
            const systemInstruction = `You are a supportive devotional assistant. Analyze the text: ${combinedText}. Your output must be a list of 3-5 specific PRAYER POINTS derived directly from the user's emotional struggles and needs, formatted clearly with bullet points. Do not offer suggestions; only frame the action as an an invitation to prayer.`;

            const insightText = await fetchGemini(prompt, systemInstruction);
            if (insightText) updateAIOutput(insightText);
        }

        async function summarizeScripture() {
            const passage = document.getElementById('ai-topic').value.trim().replace(/['"]+/g, '');
            if (!passage) {
                updateAIOutput("Please enter a Scripture reference (e.g., John 3:16) to summarize.");
                return;
            }

            document.getElementById('copy-ai-btn').style.display = 'none';

            const prompt = `Summarize the core truth and grace-centered meaning of the Scripture passage: "${passage}" in one short paragraph. Then, provide one specific, simple action step for a new Christian to apply this truth today.`;
            
            const systemInstruction = "You are a Christian Bible teacher. Your summary must be clear, focused on the gospel of grace, and easy for a new believer to understand. Output the summary, then the action step.";

            const summaryText = await fetchGemini(prompt, systemInstruction);
            if (summaryText) updateAIOutput(summaryText);
        }
        
        function copyAIOutput() {
            const textToCopy = document.getElementById('ai-insight-box').textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                displayMessage('Copied to Clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                displayMessage('Error copying text.', 'error');
            });
        }


        // --- EVENT LISTENERS AND INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            checkApiKeyStatus(); // Check API status immediately
            document.getElementById('timer-btn').addEventListener('click', startTimer);
            document.getElementById('save-api-key-btn').addEventListener('click', saveApiKey);
            document.getElementById('verify-key-btn').addEventListener('click', displaySavedKey); // Debug button
            document.getElementById('reconnect-btn').addEventListener('click', reconnectSession); // Manual reconnect button
            
            // Wire up speech-to-text buttons
            document.getElementById('mic-dream-btn').addEventListener('click', (e) => {
                e.preventDefault();
                toggleSpeech('dream-log', e.currentTarget);
            });
            document.getElementById('mic-journal-btn').addEventListener('click', (e) => {
                e.preventDefault();
                toggleSpeech('journal-log', e.currentTarget);
            });
            document.getElementById('mic-topic-btn').addEventListener('click', (e) => {
                e.preventDefault();
                toggleSpeech('ai-topic', e.currentTarget);
            });

            // Wire up checklist boxes
            Object.keys(disciplines).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', toggleDiscipline);
                }
            });
            
            // Wire up text area save buttons
            document.getElementById('save-dream-btn').addEventListener('click', () => saveLongText('dream-log', 'DreamLog', 'discipline-dream'));
            document.getElementById('save-journal-btn').addEventListener('click', () => saveLongText('journal-log', 'JournalLog', 'discipline-journal'));
            
            // Wire up AI buttons
            document.getElementById('generate-prayer-btn').addEventListener('click', handleGeneratePrayer);
            document.getElementById('summarize-scripture-btn').addEventListener('click', summarizeScripture);
            document.getElementById('analyze-journal-btn').addEventListener('click', analyzeJournal);
            document.getElementById('copy-ai-btn').addEventListener('click', copyAIOutput);
            
            // Wire up history button
            document.getElementById('load-history-btn').addEventListener('click', loadJournalHistory);
            document.getElementById('copy-history-btn').addEventListener('click', copyAllHistoryText);
        });
    </script>
</head>

<body class="bg-gray-100">
    <div id="loading-screen" class="loading-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#008080]"></div>
        <p class="mt-4 text-lg text-[#008080]">Loading Anchor...</p>
    </div>

    <div class="container">
        <!-- API KEY CONFIGURATION (CRITICAL) -->
        <div class="card bg-yellow-50" style="background-color: #fcfcf0; border: 1px dashed #ccac00;">
            <h2 class="text-xl font-bold text-[#ccac00] mb-3">üõ†Ô∏è AI Key Configuration (Required)</h2>
            <p class="text-sm text-gray-700 mb-2">The AI features need a **Gemini API Key** to run. Please ensure your key is valid and re-enter it if necessary.</p>
            <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank" class="text-sm font-semibold text-blue-600 hover:text-blue-800 underline">Click here to get your free Gemini API Key</a>
            
            <input id="api-key-input" type="password" placeholder="Paste your API Key here..." class="w-full border border-gray-300 p-2 rounded-lg mt-3 focus:ring-[#ccac00] focus:border-[#ccac00]">
            
            <div class="flex space-x-2 mt-2">
                <button id="save-api-key-btn" class="flex-1 bg-[#ccac00] hover:bg-[#a98d00] text-white font-bold py-2 rounded-lg transition duration-150 text-sm">
                    SAVE KEY & ENABLE AI
                </button>
                <button id="verify-key-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition duration-150 text-sm">
                    VERIFY SAVED KEY
                </button>
            </div>
            <p id="api-status" class="mt-2 text-sm font-semibold text-red-500">Status: Key Required.</p>
        </div>


        <!-- HEADER AND DASHBOARD -->
        <div class="card color-teal text-white p-4" style="background-color: #008080;">
            <div class="header-content">
                <h1 class="text-xl font-bold">The Morning Anchor Checklist</h1>
                <p id="user-id" class="text-sm">Session: Disconnected</p>
                <p id="today-date" class="text-sm font-semibold">Date: Loading...</p>
            </div>
            <div class="mt-2 streak-box">
                <div class="text-center flex flex-col items-center">
                    <span class="text-sm font-medium">Consecutive Streak:</span>
                    <span id="streak-count" class="text-4xl font-extrabold text-white leading-none">0</span>
                </div>
            </div>
            <button id="reconnect-btn" class="mt-3 w-full bg-[#ffb6c1] hover:bg-[#ff9aa2] text-[#2c3e50] font-bold py-2 rounded-lg transition duration-150">
                RECONNECT / SIGN IN
            </button>
        </div>

        <!-- EMERGENCY MESSAGE CONTAINER -->
        <div id="emergency-save-message" style="display: none;">
            <p class="font-bold mb-2">üõë CRITICAL SAVE FAILURE üõë</p>
            <p class="text-sm">Your secure session was dropped by the browser. **COPY YOUR TEXT NOW,** then click RECONNECT / SIGN IN above.</p>
        </div>

        <!-- 1-MINUTE READ TIMER -->
        <div class="card text-center">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">1. READ: Anchor Minute</h2>
            <div id="timer-display" class="timer-display text-[#008080] mb-4">01:00</div>
            <button id="timer-btn" class="w-full bg-[#ffb6c1] hover:bg-[#ff9aa2] text-[#2c3e50] font-bold py-3 px-4 rounded-lg transition duration-150 ease-in-out disabled:opacity-50">
                START 1-MINUTE READ
            </button>
        </div>

        <!-- DAILY DISCIPLINES CHECKLIST -->
        <div class="card">
            <h2 class="text-xl font-bold text-[#008080] mb-3">Your Daily Disciplines</h2>
            <div class="space-y-1">
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-pray">üôè 1. PRAY (Conversation)</label>
                    <input type="checkbox" id="discipline-pray" data-field="Pray" class="h-5 w-5 text-[#008080] rounded">
                </div>
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-read">üìñ 2. READ (The Word)</label>
                    <input type="checkbox" id="discipline-read" data-field="Read" class="h-5 w-5 text-[#008080] rounded">
                </div>
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-learn">üí° 3. LEARN (Teaching/Sermon)</label>
                    <input type="checkbox" id="discipline-learn" data-field="Learn" class="h-5 w-5 text-[#008080] rounded">
                </div>
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-wellness">üèÉ‚Äç‚ôÄÔ∏è 4. WELLNESS (Body as Temple)</label>
                    <input type="checkbox" id="discipline-wellness" data-field="Wellness" class="h-5 w-5 text-[#008080] rounded">
                </div>
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-dream">‚ú® 5. DREAM/VISION LOGGED</label>
                    <input type="checkbox" id="discipline-dream" data-field="Dream" class="h-5 w-5 text-[#008080] rounded">
                </div>
                <div class="discipline-item">
                    <label class="text-gray-700 font-medium" for="discipline-journal">‚úçÔ∏è 6. JOURNAL ENTRY MADE</label>
                    <input type="checkbox" id="discipline-journal" data-field="Journal" class="h-5 w-5 text-[#008080] rounded">
                </div>
            </div>
        </div>

        <!-- 5. DREAM, VISION, & KNOWLEDGE LOG -->
        <div class="card bg-purple-50" style="background-color: #fcfcf0; border: 1px solid #008080;">
            <h2 class="text-xl font-bold text-[#008080] mb-3">Dream, Vision, & Knowledge Log</h2>
            <div class="journal-header mb-3">
                <p class="text-sm text-gray-700">Record insights, dreams, or revelations received from God.</p>
                <button id="mic-dream-btn" class="mic-btn" title="Start Voice Input">üé§</button>
            </div>
            <textarea id="dream-log" rows="6" class="w-full border border-[#008080] p-3 rounded-lg focus:ring-[#008080] focus:border-[#008080] bg-white" placeholder="Speak or type your dreams and knowledge here..."></textarea>
            <button id="save-dream-btn" class="mt-2 w-full bg-[#008080] hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition duration-150">
                SAVE DREAM/VISION LOG (Auto-Checks Box)
            </button>
        </div>

        <!-- 6. MORNING REFLECTION JOURNAL -->
        <div class="card bg-blue-50" style="background-color: #fcfcf0; border: 1px solid #ffb6c1;">
            <h2 class="text-xl font-bold text-[#008080] mb-3">Morning Reflection Journal</h2>
            <div class="journal-header mb-3">
                <p class="text-sm text-gray-700">General thoughts, gratitude, or detailed reflections.</p>
                <button id="mic-journal-btn" class="mic-btn" title="Start Voice Input">üé§</button>
            </div>
            <textarea id="journal-log" rows="6" class="w-full border border-[#ffb6c1] p-3 rounded-lg focus:ring-[#ffb6c1] focus:border-[#ffb6c1] bg-white" placeholder="Speak or type your general reflection here..."></textarea>
            <button id="save-journal-btn" class="mt-2 w-full bg-[#ffb6c1] hover:bg-[#ff9aa2] text-[#2c3e50] font-bold py-2 rounded-lg transition duration-150">
                SAVE REFLECTION JOURNAL (Auto-Checks Box)
            </button>
        </div>

        <!-- GEMINI AI GUIDANCE TOOLS -->
        <div class="card bg-gray-50" style="background-color: #fcfcf0;">
            <h2 class="text-xl font-bold text-[#008080] mb-3">‚ú® Spiritual Insight Tools (Gemini AI)</h2>
            
            <p class="text-sm text-gray-700 mb-4 font-semibold border-b pb-2">
                *How to Use:* Enter a Scripture reference (e.g., John 3:16) or a Prayer Topic (e.g., Anxiety) below. Then, use the buttons for guidance.
            </p>

            <div class="flex items-center mb-4">
                <input id="ai-topic" type="text" placeholder="e.g., Psalm 91 or Topic: Finances" class="w-full border border-[#ccac00] p-2 rounded-lg focus:ring-[#ccac00] focus:focus:border-[#ccac00]">
                <button id="mic-topic-btn" class="mic-btn" title="Start Voice Input for Topic">üé§</button>
            </div>
            
            <div class="flex flex-col space-y-4">
                
                <!-- 1. PRAYER GENERATOR -->
                <div class="border-b pb-4 border-[#ffb6c1]">
                    <select id="prayer-style-selector" class="w-full p-2 border border-gray-300 rounded-lg mb-2 bg-white text-gray-700">
                        <option value="intercession">Intercessory Prayer (Breakthrough/Encouragement Style)</option>
                        <option value="prophetic">Prophetic Decree (Declarative/Amanda Grace Style)</option>
                    </select>
                    <button id="generate-prayer-btn" class="w-full bg-[#008080] hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition duration-150">
                        GENERATE 1-MINUTE MORNING PRAYER
                    </button>
                </div>
                
                <!-- 2. SCRIPTURE SUMMARIZER -->
                <button id="summarize-scripture-btn" class="w-full bg-[#ccac00] hover:bg-[#a98d00] text-white font-bold py-2 rounded-lg transition duration-150">
                    SUMMARIZE SCRIPTURE (Grace Insight)
                </button>
                
                <!-- 3. JOURNAL ANALYZER -->
                <button id="analyze-journal-btn" class="w-full bg-[#ffb6c1] hover:bg-[#ff9aa2] text-[#2c3e50] font-bold py-2 rounded-lg transition duration-150">
                    ANALYZE JOURNAL & GENERATE PRAYER POINTS
                </button>
            </div>

            <!-- AI OUTPUT SECTION -->
            <div class="mt-6">
                <p class="text-md font-bold text-[#2c3e50]">AI Insight Box:</p>
                <div id="ai-insight-box" class="ai-output-box min-h-[50px] text-gray-800">
                    Your custom guidance will appear here after clicking a button above.
                </div>
                <button id="copy-ai-btn" onclick="copyAIOutput()" class="mt-3 bg-[#ccac00] text-white hover:bg-[#a98d00] font-bold py-2 px-4 rounded-lg text-sm transition duration-150 hidden">
                    COPY PRAYER / INSIGHT TEXT
                </button>
            </div>
        </div>

        <!-- JOURNAL HISTORY SECTION -->
        <div class="card bg-gray-50" style="background-color: #fcfcf0;">
            <h2 class="text-xl font-bold text-[#008080] mb-3">Journal History & Export</h2>
            <p class="text-sm text-gray-600 mb-4">View and export all your past reflections for scrapbooking or deeper review.</p>
            
            <button id="load-history-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded-lg transition duration-150 mb-4">
                Load Full Journal History
            </button>
            
            <div id="history-output" class="text-sm text-gray-700 border border-gray-300 p-3 rounded-lg bg-white min-h-[50px]">
                Click 'Load Full Journal History' to retrieve past entries.
            </div>

            <button id="copy-history-btn" class="mt-3 w-full bg-[#008080] hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition duration-150 hidden">
                Copy All History Text (for Scrapbook)
            </button>
        </div>
    </div>

    <!-- STATUS MESSAGE -->
    <div id="status-message" class="status-message hidden"></div>
</body>
</html>
