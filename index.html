<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Anchor Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fcfcf0; /* Soft Off-White Background */
            padding: 10px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; 
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(44, 62, 80, 0.1); /* Deep Shadow */
            margin-bottom: 16px;
            padding: 16px;
        }
        .discipline-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .discipline-item:last-child {
            border-bottom: none;
        }
        /* Custom Colors */
        .color-teal { background-color: #008080; } /* Moss Teal Green */
        .color-pink { background-color: #ffb6c1; } /* Light Pink */
        .color-gold { color: #ccac00; } /* Gold Text */
        
        .status-message {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffb6c1; /* Soft Pink for status */
            color: #2c3e50;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(252, 252, 240, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10000;
            transition: opacity 0.5s;
        }
        .timer-display {
            font-size: 2.8rem;
            font-weight: 800;
            color: #008080; /* Moss Teal */
        }
        .ai-output-box {
            background-color: #fcfcf0; /* Cream background */
            border: 1px solid #ccac00; /* Gold border */
            border-left: 5px solid #ccac00;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .history-entry {
            border-bottom: 1px dashed #ccc;
            padding-bottom: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .mic-btn {
            background-color: transparent;
            border: none;
            color: #ffb6c1; /* Soft Pink */
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 10px;
            transition: color 0.2s;
        }
        .mic-btn.listening {
            color: red;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Custom Class for Header Centering */
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            text-align: center;
        }
        .streak-box {
            display: flex;
            justify-content: center; /* Center the streak elements */
            align-items: center;
            width: 100%;
            padding-top: 8px;
        }
        /* Emergency Message Styling */
        #emergency-save-message {
            background-color: #fcebeb; /* Light red/pink background */
            color: #cc0000;
            border: 2px solid #cc0000;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .emergency-btn {
            background-color: #cc0000;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // --- GLOBAL CONFIGURATION & STATE ---
        let db, auth, userId = null;
        const today = new Date();
        const todayKey = today.toISOString().split('T')[0]; // YYYY-MM-DD
        const formattedDate = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-anchor-app';

        // NOTE: These must be your actual Firebase Project keys!
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCCUPLsELc01gUOj2VCd-B-Vof7tgJC7vg", 
            authDomain: "morning-anchor.firebaseapp.com",
            projectId: "morning-anchor",
            storageBucket: "morning-anchor.firebasestorage.app",
            messagingSenderId: "167064191841",
            appId: "1:167064191841:web:ca6f33aa4a7f1c7e99bb20"
        };
        
        // Discipline IDs (mapped to database fields and UI)
        const disciplines = {
            'discipline-pray': 'Pray',
            'discipline-read': 'Read',
            'discipline-learn': 'Learn',
            'discipline-wellness': 'Wellness',
            'discipline-dream': 'Dream',
            'discipline-journal': 'Journal'
        };
        let timerInterval = null;
        let timerSeconds = 60;
        let recognition = null; // For Speech-to-Text
        
        // --- API KEY HANDLING (CRITICAL FIX) ---
        let savedApiKey = localStorage.getItem('GEMINI_API_KEY') || "";

        // --- AUTHENTICATION STATE TRACKING ---
        let isAuthenticated = false;
        let lastLoadedDate = null; // Used to track if midnight has passed

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up listener to manage session state globally
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthenticated = true;
                        // Display status using user's name/email/ID
                        document.getElementById('user-id').textContent = `Session: Connected (${user.displayName || user.email || 'ID: ' + userId.substring(0, 8)}...)`;
                        document.getElementById('user-id').style.color = '#ffb6c1'; // Soft Pink for connected state
                        loadDailyData();
                    } else {
                        userId = null;
                        isAuthenticated = false;
                        document.getElementById('user-id').textContent = 'Session: Disconnected. Sign In to save.';
                        document.getElementById('user-id').style.color = '#cc0000'; // Red for disconnected state
                        hideLoading();
                    }
                });

                // NO AUTOMATIC SIGN-IN. The user must click RECONNECT.

                // --- FAIL-SAFE TIMER (CRITICAL FIX) ---
                setTimeout(() => {
                    if (document.getElementById('loading-screen').style.opacity !== '0') {
                        displayMessage('Connection timeout. Please check console for configuration errors.', 'error');
                        hideLoading();
                    }
                }, 5000); // Guarantees loading screen closes after 5s

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage('App initialization failed. Check console for Firebase config errors.', 'error');
                hideLoading();
            }
        }
        
        async function reconnectSession() {
            if (isAuthenticated) {
                displayMessage('Already signed in!', 'success');
                return;
            }
            displayMessage('Opening Google Sign In...', 'success');
            
            try {
                const provider = new GoogleAuthProvider();
                // Force a pop-up sign-in to get the strong, verifiable token
                await signInWithPopup(auth, provider);
                // The onAuthStateChanged listener will handle the success flow
            } catch (error) {
                console.error("Google Sign In Failed:", error);
                // Check if error is due to unauthorized domain or popup issues
                if (error.code === 'auth/unauthorized-domain') {
                    displayMessage('Error: Unauthorized Domain. You must add this URL to your Firebase Authentication settings.', 'error');
                } else if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                     displayMessage('Sign In cancelled. Please ensure pop-ups are allowed.', 'error');
                } else {
                     displayMessage(`Sign In failed (${error.code}). Please check console.`, 'error');
                }
            }
        }


        // --- API KEY CONFIGURATION ---
        function saveApiKey() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            if (inputKey.length > 5 && inputKey.startsWith('AIza')) { // Basic validation
                localStorage.setItem('GEMINI_API_KEY', inputKey);
                savedApiKey = inputKey;
                document.getElementById('api-status').textContent = 'Key Saved! AI features enabled.';
                document.getElementById('api-status').classList.remove('text-red-500');
                document.getElementById('api-status').classList.add('text-[#008080]');
                displayMessage('API Key Saved Successfully! AI is now active.');
            } else {
                displayMessage('Please enter a valid Gemini API Key (starts with AIza).', 'error');
            }
        }

        function checkApiKeyStatus() {
            const statusElement = document.getElementById('api-status');
            if (savedApiKey) {
                statusElement.textContent = 'Key Active. AI features enabled.';
                statusElement.classList.remove('text-red-500');
                statusElement.classList.add('text-[#008080]');
                document.getElementById('api-key-input').value = savedApiKey.substring(0, 5) + '...';
            } else {
                statusElement.textContent = 'Key Required. AI features disabled.';
                statusElement.classList.remove('text-[#008080]');
                statusElement.classList.add('text-red-500');
            }
        }
        
        function displaySavedKey() {
            if (savedApiKey) {
                const partialKey = savedApiKey.substring(0, 8);
                document.getElementById('api-status').textContent = `Loaded Key: ${partialKey}...`;
            } else {
                document.getElementById('api-status').textContent = "No key found in browser storage.";
            }
        }


        // --- DATABASE FUNCTIONS ---
        const getDailyDocRef = (uid) => doc(db, `artifacts/${app_id}/users/${uid}/morning_checkins`, todayKey);
        const getCollectionRef = (uid) => collection(db, `artifacts/${app_id}/users/${uid}/morning_checkins`);

        async function loadDailyData() {
            const docRef = getDailyDocRef(userId);
            
            // Set up real-time listener for checklist and streaks
            onSnapshot(docRef, (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                
                // --- DATA CLEARANCE LOGIC (The Fix) ---
                if (data.lastLoadedDate && data.lastLoadedDate !== todayKey) {
                    // Midnight has passed: Clear the journal boxes and save the new load date
                    document.getElementById('dream-log').value = '';
                    document.getElementById('journal-log').value = '';
                    setDoc(docRef, { lastLoadedDate: todayKey }, { merge: true });
                    displayMessage('New Day started! Journal cleared.', 'success');
                } else if (!data.lastLoadedDate) {
                     // First time loading for this user/day: set the load date
                    setDoc(docRef, { lastLoadedDate: todayKey }, { merge: true });
                }
                
                // 1. Update Checkboxes
                Object.keys(disciplines).forEach(id => {
                    const field = disciplines[id];
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = !!data[field];
                        if (field === 'Read' && data[field]) {
                             document.getElementById('timer-btn').disabled = true;
                             document.getElementById('timer-btn').textContent = "READ DONE!";
                             document.getElementById('timer-display').textContent = "00:00";
                        } else if (field === 'Read' && !data[field]) {
                             document.getElementById('timer-btn').disabled = false;
                             document.getElementById('timer-btn').textContent = "START 1-MINUTE READ";
                             if (timerInterval === null) {
                                document.getElementById('timer-display').textContent = "01:00";
                             }
                        }
                    }
                });

                // 2. Update Long Text Areas (Load existing data if available)
                if (document.getElementById('dream-log').value === '') {
                    document.getElementById('dream-log').value = data.DreamLog || '';
                }
                if (document.getElementById('journal-log').value === '') {
                    document.getElementById('journal-log').value = data.JournalLog || '';
                }

                // 3. Update Streak Display 
                document.getElementById('streak-count').textContent = data.streak || 0; 

                hideLoading();
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                displayMessage('Error loading data. Check connection and try reconnecting.', 'error');
                hideLoading();
            });
        }

        async function toggleDiscipline(event) {
            // PROACTIVE AUTH CHECK (Critical for saving)
            if (!isAuthenticated) {
                displayMessage('Session lost. Click "RECONNECT / SIGN IN" above.', 'error');
                return;
            }
            
            const field = event.target.dataset.field;
            const isChecked = event.target.checked;
            
            // FIX: Use setDoc with merge: true to CREATE the document if it doesn't exist
            try {
                await setDoc(getDailyDocRef(userId), { [field]: isChecked }, { merge: true });
                displayMessage(`${field} status saved!`);
            } catch (e) {
                // FINAL FIX: This is the failure point. Prompt user to copy/refresh.
                document.getElementById('emergency-save-message').style.display = 'block';
                displayMessage('CRITICAL SAVE FAILURE: Checkbox save failed. Click RECONNECT/SIGN IN.', 'error');
            }
        }

        async function saveLongText(fieldId, dataField, checkboxId) {
            // PROACTIVE AUTH CHECK (The Fix)
            if (!isAuthenticated) {
                 displayMessage('CRITICAL SAVE FAILURE: Session lost. Copy text, then click RECONNECT.', 'error');
                 document.getElementById('emergency-save-message').style.display = 'block';
                 return; 
            }
            
            const text = document.getElementById(fieldId).value;
            const docRef = getDailyDocRef(userId);
            
            const updates = {
                [dataField]: text,
                lastLoadedDate: todayKey, // Ensure the date is marked when saving text
                lastUpdated: new Date().toISOString()
            };

            // Auto-check the discipline box if content is saved
            if (checkboxId) {
                const checkboxField = disciplines[checkboxId];
                updates[checkboxField] = true;
                // FIX: Checkmark logic also uses setDoc now for safety
                try {
                    await setDoc(getDailyDocRef(userId), { [checkboxField]: true }, { merge: true });
                } catch (e) {
                    // Fail gracefully
                    console.warn('Failed to auto-check box, proceeding with text save.');
                }
            }

            // Save the journal content (always uses setDoc for safety)
            try {
                await setDoc(docRef, updates, { merge: true });
                displayMessage('Log Saved!');
                document.getElementById('emergency-save-message').style.display = 'none'; // Clear emergency message on success
            } catch (e) {
                console.error("Long text save failed:", e);
                // FINAL FIX: Provide explicit instructions to user on how to recover data before refreshing
                document.getElementById('emergency-save-message').style.display = 'block';
                displayMessage('CRITICAL SAVE FAILURE: Session expired. COPY your text NOW, then click RECONNECT.', 'error');
            }
        }
        
        async function loadJournalHistory() {
            if (!isAuthenticated) {
                document.getElementById('history-output').innerHTML = '<p class="text-red-500">History failed to load. Please sign in first.</p>';
                return;
            }
            
            document.getElementById('history-output').innerHTML = '<p class="text-teal-600">Loading history...</p>';
            const q = query(getCollectionRef(userId));
            
            try {
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    document.getElementById('history-output').innerHTML = '<p class="text-gray-500">No past entries found.</p>';
                    return;
                }
                
                let historyHTML = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const date = doc.id;
                    
                    const reflection = data.JournalLog ? `**Reflection:** ${data.JournalLog.substring(0, 150)}...` : '';
                    const dream = data.DreamLog ? `**Dream/Vision:** ${data.DreamLog.substring(0, 150)}...` : '';
                    
                    if (reflection || dream) {
                        historyHTML += `
                            <div class="history-entry">
                                <p class="font-bold text-lg text-teal-700">${date}</p>
                                ${reflection ? `<p class="mt-1 text-sm">${reflection}</p>` : ''}
                                ${dream ? `<p class="mt-1 text-sm">${dream}</p>` : ''}
                            </div>
                        `;
                    }
                });
                
                document.getElementById('history-output').innerHTML = historyHTML;
                document.getElementById('copy-history-btn').style.display = 'block';
            } catch (e) {
                console.error("History load error:", e);
                 document.getElementById('history-output').innerHTML = `<p class="text-red-500">Error: Could not load history. Please ensure you are signed in and have set security rules.</p>`;
            }
        }

        async function copyAllHistoryText() {
            const q = query(getCollectionRef(userId));
            const querySnapshot = await getDocs(q);
            
            let fullText = '--- FAITH FOUNDATIONS FULL JOURNAL HISTORY ---\n\n';
            
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const date = doc.id;
                
                fullText += `\n--- ENTRY: ${date} ---\n`;
                if (data.JournalLog) fullText += `REFLECTION JOURNAL:\n${data.JournalLog}\n\n`;
                if (data.DreamLog) fullText += `DREAM/VISION LOG:\n${data.DreamLog}\n\n`;
            });

            navigator.clipboard.writeText(fullText).then(() => {
                displayMessage('Full History Copied to Clipboard!');
            }).catch(err => {
                console.error('Could not copy history: ', err);
                displayMessage('Error copying history.', 'error');
            });
        }

        // --- UI AND UTILITY FUNCTIONS ---
        function displayMessage(message, type = 'success') {
            const msgElement = document.getElementById('status-message');
            msgElement.textContent = message;
            msgElement.className = `status-message ${type === 'success' ? 'bg-[#ffb6c1]' : 'bg-red-600'} text-[#2c3e50]`;
            clearTimeout(msgElement.timeout);
            msgElement.timeout = setTimeout(() => {
                msgElement.textContent = '';
                msgElement.className = 'status-message hidden';
            }, 3000);
        }

        function hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            }
        }

        // --- TIMER FUNCTIONS ---
        function startTimer() {
            if (timerInterval) return;
            if (!isAuthenticated) {
                displayMessage('Sign in required to start timer and save progress.', 'error');
                return;
            }

            const timerDisplay = document.getElementById('timer-display');
            const timerButton = document.getElementById('timer-btn');
            timerSeconds = 60;
            timerDisplay.textContent = "01:00";
            timerDisplay.classList.remove('text-red-600', 'animate-pulse');

            timerButton.disabled = true;
            timerButton.textContent = 'RUNNING...';

            timerInterval = setInterval(async () => {
                timerSeconds--;

                if (timerSeconds < 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerDisplay.textContent = "TIME!";
                    timerDisplay.classList.add('text-red-600', 'animate-pulse');

                    const readCheckbox = document.getElementById('discipline-read');
                    readCheckbox.checked = true;
                    
                    // Save to Firestore and update UI via snapshot listener
                    await setDoc(getDailyDocRef(userId), { [disciplines['discipline-read']]: true }, { merge: true });
                    
                    displayMessage('Anchor Minute Complete! Read box checked.');

                    if (navigator.vibrate) {
                        navigator.vibrate(1000);
                    }

                    setTimeout(() => {
                        timerButton.textContent = "READ DONE!";
                    }, 2000);

                    return;
                }
                
                const minutes = Math.floor(timerSeconds / 60);
                const seconds = timerSeconds % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // --- SPEECH-TO-TEXT FUNCTIONS ---
        function toggleSpeech(targetId, micButton) {
            // Check for secure context and API support
            if (window.location.protocol !== 'https:') {
                displayMessage('Speech-to-Text requires a secure (https://) link to work.', 'error');
                return;
            }
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                displayMessage('Speech recognition not supported in this browser.', 'error');
                return;
            }

            if (recognition && recognition.state === 'listening') {
                recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US'; 

            recognition.onstart = () => {
                micButton.classList.add('listening');
                displayMessage('Listening... speak now.');
            };

            recognition.onresult = (event) => {
                const finalTranscript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                const element = document.getElementById(targetId);
                // For textarea, append text. For input, replace text.
                if (targetId === 'ai-topic') {
                    element.value = finalTranscript;
                } else {
                    element.value += (element.value ? ' ' : '') + finalTranscript;
                }

                micButton.classList.remove('listening');
                displayMessage('Transcription complete.');
            };

            recognition.onerror = (event) => {
                micButton.classList.remove('listening');
                displayMessage(`Speech error: ${event.error}. Ensure mic access is allowed.`, 'error');
                console.error('Speech Recognition Error:', event.error);
            };

            recognition.onend = () => {
                micButton.classList.remove('listening');
            };

            recognition.start();
        }


        // --- GEMINI API FUNCTIONS ---
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;

        async function fetchGemini(prompt, systemInstruction = null) {
            if (!savedApiKey) {
                const errorMessage = "AI Key Missing. Please set your Gemini API Key in the configuration card above.";
                document.getElementById('ai-insight-box
